<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue2响应式源码 | Ming&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <noscript><meta http-equiv="refresh" content="0; url=https://www.youngkbt.cn/noscript/"><style>.theme-vdoing-content { display:none }</noscript>
    <script src="https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js"></script>
    <script>var _hmt = _hmt || [];
          (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?267c5680c2ffb468ca29c45ffe6801da"; 
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
          })();
          </script>
    <meta name="description" content="web前端技术博客, VuePress搭建, 使用了 Vdoing 主题,专注web前端学习与总结。学习JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等相关知识, 记录生活和技术路程, 同时分享编程技巧。">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="Young Kbt个人博客, VuePress搭建, 学习Java、Web、框架、微服务、工具、前端等相关知识, 记录生活和技术路程。">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.57beb9dd.css" as="style"><link rel="preload" href="/assets/js/app.9ce89328.js" as="script"><link rel="preload" href="/assets/js/2.f5951ee7.js" as="script"><link rel="preload" href="/assets/js/82.d8694b66.js" as="script"><link rel="preload" href="/assets/js/15.8f34ae65.js" as="script"><link rel="preload" href="/assets/js/5.80fa8520.js" as="script"><link rel="preload" href="/assets/js/9.a3a07a71.js" as="script"><link rel="preload" href="/assets/js/8.00efa629.js" as="script"><link rel="prefetch" href="/assets/js/10.01f08460.js"><link rel="prefetch" href="/assets/js/100.67cdec04.js"><link rel="prefetch" href="/assets/js/101.0179f79a.js"><link rel="prefetch" href="/assets/js/102.193ab642.js"><link rel="prefetch" href="/assets/js/103.adb7b3ef.js"><link rel="prefetch" href="/assets/js/104.bb50b48e.js"><link rel="prefetch" href="/assets/js/105.9b0076e6.js"><link rel="prefetch" href="/assets/js/106.810351da.js"><link rel="prefetch" href="/assets/js/107.770b25d4.js"><link rel="prefetch" href="/assets/js/108.4cc2b80c.js"><link rel="prefetch" href="/assets/js/109.bb88a410.js"><link rel="prefetch" href="/assets/js/11.6965dc33.js"><link rel="prefetch" href="/assets/js/110.1057d2bb.js"><link rel="prefetch" href="/assets/js/111.6976aaa5.js"><link rel="prefetch" href="/assets/js/112.091e3496.js"><link rel="prefetch" href="/assets/js/113.361d9f2b.js"><link rel="prefetch" href="/assets/js/114.5ab74754.js"><link rel="prefetch" href="/assets/js/115.a1eb5f2c.js"><link rel="prefetch" href="/assets/js/116.d25015c5.js"><link rel="prefetch" href="/assets/js/117.449026c8.js"><link rel="prefetch" href="/assets/js/118.822157f1.js"><link rel="prefetch" href="/assets/js/119.10a0c829.js"><link rel="prefetch" href="/assets/js/12.04b2320f.js"><link rel="prefetch" href="/assets/js/120.10699888.js"><link rel="prefetch" href="/assets/js/121.c637a980.js"><link rel="prefetch" href="/assets/js/122.4c9109a0.js"><link rel="prefetch" href="/assets/js/123.58026fde.js"><link rel="prefetch" href="/assets/js/124.c495d639.js"><link rel="prefetch" href="/assets/js/125.9394c1b7.js"><link rel="prefetch" href="/assets/js/126.c97b7f50.js"><link rel="prefetch" href="/assets/js/127.7f281e80.js"><link rel="prefetch" href="/assets/js/128.c95cb2f1.js"><link rel="prefetch" href="/assets/js/129.49bfff21.js"><link rel="prefetch" href="/assets/js/13.f5967695.js"><link rel="prefetch" href="/assets/js/130.d6d35cac.js"><link rel="prefetch" href="/assets/js/14.120f01ce.js"><link rel="prefetch" href="/assets/js/16.da36ec39.js"><link rel="prefetch" href="/assets/js/17.d6154bd1.js"><link rel="prefetch" href="/assets/js/18.d2e78319.js"><link rel="prefetch" href="/assets/js/19.d63bd086.js"><link rel="prefetch" href="/assets/js/20.e9ef98ac.js"><link rel="prefetch" href="/assets/js/21.69f7540a.js"><link rel="prefetch" href="/assets/js/22.a88cba2e.js"><link rel="prefetch" href="/assets/js/23.ddbc3ed5.js"><link rel="prefetch" href="/assets/js/24.8aa156d2.js"><link rel="prefetch" href="/assets/js/25.2d310d73.js"><link rel="prefetch" href="/assets/js/26.83a32a24.js"><link rel="prefetch" href="/assets/js/27.45caf8fe.js"><link rel="prefetch" href="/assets/js/28.9e25c263.js"><link rel="prefetch" href="/assets/js/29.f59ebaf6.js"><link rel="prefetch" href="/assets/js/3.a5286238.js"><link rel="prefetch" href="/assets/js/30.7a276a76.js"><link rel="prefetch" href="/assets/js/31.efca4faf.js"><link rel="prefetch" href="/assets/js/32.81d02bc9.js"><link rel="prefetch" href="/assets/js/33.162743ea.js"><link rel="prefetch" href="/assets/js/34.2cdd6ead.js"><link rel="prefetch" href="/assets/js/35.2231b486.js"><link rel="prefetch" href="/assets/js/36.84f851d4.js"><link rel="prefetch" href="/assets/js/37.b9c7b886.js"><link rel="prefetch" href="/assets/js/38.898dcd14.js"><link rel="prefetch" href="/assets/js/39.48b68a5d.js"><link rel="prefetch" href="/assets/js/4.d14eaad4.js"><link rel="prefetch" href="/assets/js/40.19416517.js"><link rel="prefetch" href="/assets/js/41.b9fc92e5.js"><link rel="prefetch" href="/assets/js/42.ce346e99.js"><link rel="prefetch" href="/assets/js/43.f188fedb.js"><link rel="prefetch" href="/assets/js/44.bb6f56d2.js"><link rel="prefetch" href="/assets/js/45.69c867be.js"><link rel="prefetch" href="/assets/js/46.3c9d28a8.js"><link rel="prefetch" href="/assets/js/47.10b373c1.js"><link rel="prefetch" href="/assets/js/48.d9e402f5.js"><link rel="prefetch" href="/assets/js/49.60a8fab4.js"><link rel="prefetch" href="/assets/js/50.81c21077.js"><link rel="prefetch" href="/assets/js/51.1cc4bb83.js"><link rel="prefetch" href="/assets/js/52.8d2cdae4.js"><link rel="prefetch" href="/assets/js/53.e570f209.js"><link rel="prefetch" href="/assets/js/54.1e06951c.js"><link rel="prefetch" href="/assets/js/55.64e72812.js"><link rel="prefetch" href="/assets/js/56.4cae741a.js"><link rel="prefetch" href="/assets/js/57.ef803625.js"><link rel="prefetch" href="/assets/js/58.1ea37da9.js"><link rel="prefetch" href="/assets/js/59.43780741.js"><link rel="prefetch" href="/assets/js/6.6e6d5e8a.js"><link rel="prefetch" href="/assets/js/60.ce437f17.js"><link rel="prefetch" href="/assets/js/61.2751887b.js"><link rel="prefetch" href="/assets/js/62.8895dde5.js"><link rel="prefetch" href="/assets/js/63.fa94ccc8.js"><link rel="prefetch" href="/assets/js/64.fa6c97a4.js"><link rel="prefetch" href="/assets/js/65.ecccf6b5.js"><link rel="prefetch" href="/assets/js/66.00e32ac7.js"><link rel="prefetch" href="/assets/js/67.38c5d4fc.js"><link rel="prefetch" href="/assets/js/68.9354682a.js"><link rel="prefetch" href="/assets/js/69.798d4c5c.js"><link rel="prefetch" href="/assets/js/7.74e99897.js"><link rel="prefetch" href="/assets/js/70.ad5d9eba.js"><link rel="prefetch" href="/assets/js/71.d8b7dd18.js"><link rel="prefetch" href="/assets/js/72.cbcd658e.js"><link rel="prefetch" href="/assets/js/73.2b2bdfbd.js"><link rel="prefetch" href="/assets/js/74.9ef8250a.js"><link rel="prefetch" href="/assets/js/75.ee74c53b.js"><link rel="prefetch" href="/assets/js/76.b3741378.js"><link rel="prefetch" href="/assets/js/77.de9d53ee.js"><link rel="prefetch" href="/assets/js/78.66cca25d.js"><link rel="prefetch" href="/assets/js/79.438142bf.js"><link rel="prefetch" href="/assets/js/80.89eb3fa4.js"><link rel="prefetch" href="/assets/js/81.4c11e07f.js"><link rel="prefetch" href="/assets/js/83.92e9cb8e.js"><link rel="prefetch" href="/assets/js/84.923e6345.js"><link rel="prefetch" href="/assets/js/85.a8975b01.js"><link rel="prefetch" href="/assets/js/86.7c63a86c.js"><link rel="prefetch" href="/assets/js/87.1b4d6359.js"><link rel="prefetch" href="/assets/js/88.8e86e14b.js"><link rel="prefetch" href="/assets/js/89.5f99d004.js"><link rel="prefetch" href="/assets/js/90.97d4e502.js"><link rel="prefetch" href="/assets/js/91.f015f724.js"><link rel="prefetch" href="/assets/js/92.c4d04cfe.js"><link rel="prefetch" href="/assets/js/93.9ab5bc13.js"><link rel="prefetch" href="/assets/js/94.c0d85f9c.js"><link rel="prefetch" href="/assets/js/95.43bed309.js"><link rel="prefetch" href="/assets/js/96.b8a54cf9.js"><link rel="prefetch" href="/assets/js/97.5357cbc5.js"><link rel="prefetch" href="/assets/js/98.4bbda207.js"><link rel="prefetch" href="/assets/js/99.e3e97233.js">
    <link rel="stylesheet" href="/assets/css/0.styles.57beb9dd.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/index/logo.png" alt="Ming's blog" class="logo"> <span class="site-name can-hide">Ming's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><a href="/basics/" class="link-title">前端基础</a> <span class="title" style="display:none;">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basics/HTML/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/basics/CSS2/" class="nav-link">Css</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JS" class="dropdown-title"><a href="/javascript/" class="link-title">JS</a> <span class="title" style="display:none;">JS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/JSbasics/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/JS-ES6/" class="nav-link">ES6</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web Api" class="dropdown-title"><a href="/tool/" class="link-title">Web Api</a> <span class="title" style="display:none;">Web Api</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">Dom</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">Bom</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">axios</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">跨域</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">事件</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">存储</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/git/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>构建工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Webpack/" class="nav-link">Webpack</a></li><li class="dropdown-subitem"><a href="/Vite/" class="nav-link">Vite</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Demo" class="dropdown-title"><!----> <span class="title" style="display:;">Demo</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://124.222.141.165:90/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  神领物流
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://124.222.141.165:99/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  尺锤人员管理
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/feynmanLearningMethod/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/more/advanced/" class="nav-link">进阶</a></li><li class="dropdown-item"><!----> <a href="/more/interview/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/more/interview-vue/" class="nav-link">技术面</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/about/website/introduce/" class="nav-link">关于</a></li><li class="dropdown-subitem"><a href="https://vue2-admin.youngkbt.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue2-Admin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><a href="/navigation/" class="nav-link">导航站</a></div><div class="nav-item"><a href="/message-area/" class="nav-link">留言区</a></div> <a href="https://github.com/Ming-D-W" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://photo-album-1314189846.cos.ap-shanghai.myqcloud.com/202303171033443.png"> <div class="blogger-info"><h3>Da Wu</h3> <span>朝圣的使徒，正在走向编程的至高殿堂！</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><a href="/basics/" class="link-title">前端基础</a> <span class="title" style="display:none;">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basics/HTML/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/basics/CSS2/" class="nav-link">Css</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JS" class="dropdown-title"><a href="/javascript/" class="link-title">JS</a> <span class="title" style="display:none;">JS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/JSbasics/" class="nav-link">基础</a></li><li class="dropdown-item"><!----> <a href="/JS-ES6/" class="nav-link">ES6</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web Api" class="dropdown-title"><a href="/tool/" class="link-title">Web Api</a> <span class="title" style="display:none;">Web Api</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">Dom</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">Bom</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">axios</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">跨域</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">事件</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">存储</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/git/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>构建工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Webpack/" class="nav-link">Webpack</a></li><li class="dropdown-subitem"><a href="/Vite/" class="nav-link">Vite</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Demo" class="dropdown-title"><!----> <span class="title" style="display:;">Demo</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://124.222.141.165:90/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  神领物流
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://124.222.141.165:99/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  尺锤人员管理
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/feynmanLearningMethod/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/more/advanced/" class="nav-link">进阶</a></li><li class="dropdown-item"><!----> <a href="/more/interview/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/more/interview-vue/" class="nav-link">技术面</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/about/website/introduce/" class="nav-link">关于</a></li><li class="dropdown-subitem"><a href="https://vue2-admin.youngkbt.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vue2-Admin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><a href="/navigation/" class="nav-link">导航站</a></div><div class="nav-item"><a href="/message-area/" class="nav-link">留言区</a></div> <a href="https://github.com/Ming-D-W" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>面试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>技术面</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/e4dc2c/" class="sidebar-link">JS</a></li><li><a href="/pages/26cc37/" class="sidebar-link">CSS</a></li><li><a href="/pages/d178b0/" class="sidebar-link">浏览器&amp;http</a></li><li><a href="/more/interview-vue/" class="sidebar-link">Vue</a></li><li><a href="/pages/3d4029/" class="sidebar-link">new Vue的流程</a></li><li><a href="/pages/053424/" aria-current="page" class="active sidebar-link">Vue2响应式源码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/053424/#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header level2"><a href="/pages/053424/#编译模板的步骤-ast" class="sidebar-link">编译模板的步骤 AST</a></li><li class="sidebar-sub-header level2"><a href="/pages/053424/#虚拟dom进行对比" class="sidebar-link">虚拟dom进行对比</a></li><li class="sidebar-sub-header level2"><a href="/pages/053424/#观察者模式" class="sidebar-link">观察者模式</a></li><li class="sidebar-sub-header level2"><a href="/pages/053424/#观察者模式进行数据更新" class="sidebar-link">观察者模式进行数据更新</a></li><li class="sidebar-sub-header level2"><a href="/pages/053424/#nexttick页面的异步的更新" class="sidebar-link">nextTick页面的异步的更新</a></li><li class="sidebar-sub-header level2"><a href="/pages/053424/#步骤详解" class="sidebar-link">步骤详解</a></li></ul></li><li><a href="/pages/e1d719/" class="sidebar-link">Vue2 Diff 算法</a></li></ul></section></li><li><a href="/friends/" class="sidebar-link">友情连接</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E6%9B%B4%E5%A4%9A" title="分类" data-v-06225672>更多</a></li><li data-v-06225672><a href="/categories/?category=%E6%8A%80%E6%9C%AF%E9%9D%A2" title="分类" data-v-06225672>技术面</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/Ming-D-W" target="_blank" title="作者" class="beLink" data-v-06225672>Ming</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-03-15</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Vue2响应式源码<span class="title-tag">原创</span></h1> <!----> <div class="theme-vdoing-content content__default"><div class="custom-block note"><p class="custom-block-title">序言</p> <p>在vue2中，数据响应式更新主要是通过watcher，dep，observe三个核心来实现的，其中watcher是用来观察表达式的变化，发生变化的时候来更新视图，dep是用来收集和管理vue实例中所有的watcher，同时也用来通知已经收集到的watcher来进行更新，最后还有observe用来遍历所有对象，给他们添加get和set方法。</p> <div class="custom-block right"><p>2022-07-15 @Du Wu</p></div></div> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <blockquote><p>在vue2中，数据响应式更新主要是通过watcher，dep，observe三个核心来实现的，其中watcher是用来观察表达式的变化，发生变化的时候来更新视图，dep是用来收集和管理vue实例中所有的watcher，同时也用来通知已经收集到的watcher来进行更新，最后还有observe用来遍历所有对象，给他们添加get和set方法。
具体是当一个vue实例被创建的时候，vue用observe会先遍历对象的所有属性，并通过Object.defineProperty将其添加getter和setter属性，这件事情是发生在beforCreated之后，Created之前。
但是这里有两个问题，当对象里套对象之类的比较深的时候，普通遍历是遍历不到那么深的，所以它会进行递归遍历，这样就可以完成深度的属性转换。
第二个问题是，当对象的属性一开始没有后面才有，这样一开始的时候这个数据没有被劫持到，这个数据就不是响应式的了，所以需要我们手动劫持使用$set或者$delete来添加数据或者删除数据。</p> <p>然后，当数据是数组的话，vue会更改它的原型指向，让它指向vue自己重新更改的七个改变数组方法，但是为了让数组依然保持数组的特性，vue又把自己的隐式原型再指向数组的方法。
这里也会有一个问题，数组是监测不到里面的属性的，当你想单独使用数组里面的某一个数据的时候，比如赋值，是没办法做到响应式更新的，所以这个时候我们还是可以使用$set手动修改。</p> <p>所以简单来说，observe就做了一件事，它把一个普通的对象，让他的所有属性尽量的变成一个响应式，可以读取属性，改变属性，可以收到通知</p> <p>那么dep是用来干嘛的呢？dep是在observe把数据变成响应式的时候，为对象中的每一个属性，数组创建一个dep实例，每个dep实例用来记录依赖（谁在用我），派发更新（我更新了，要通知用到我的人）。</p> <p>那dep是怎么知道谁在用到它的呢，这里vue就用到了一个巧妙的方法watcher，vue中每个组件渲染过程中都会对应一个watcher实例，当一个组件使用到数据的时候，就会触发数据的get方法，就会将当前组件的更新watcher添加到数据的dep数组内，当数据发生变化的时候，vue会调用dep.notify方法去调用dep数组里的更新watcher里的updata方法进行页面更新。</p> <p>总结简单来说dep管理依赖项和通知更新，然后watcher观察对象的变化，接收dep的通知重新收集依赖并执行回调函数。</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 观测这个数据</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当我们new Vue之后，做了什么事情？</p> <ol><li><p>当我们new Vue之后，调用了Vue构造函数，传入配置项</p></li> <li><p>Vue构造函数传入的配置项，调用this._init(options)方法</p></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Object.defineProperty() vue2版本的数据劫持</span>
<span class="token comment">// 构造函数或者类</span>
<span class="token keyword">function</span> <span class="token function">Vue</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// console.log(options)</span>
  <span class="token comment">// 内部要进行初始化的操作</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化操作</span>
<span class="token punctuation">}</span>

<span class="token comment">// 原型模式</span>
<span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加原型的方法</span>
<span class="token function">renderMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">lifeCycleMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// initGlobalApi 给构造函数来扩展全局的方法</span>
<span class="token function">initGlobalAPI</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$nextTick <span class="token operator">=</span> nextTick
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol start="3"><li><p>_init方法时通过原型模式进行注入的</p></li> <li><p>提供一个_initMixin方法，传入Vue构造函数</p></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 传入的构造函数的原型上添加方法</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Vue的内部 $options 就是用户传递的所有参数</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// this指向initMixin的实例</span>
    <span class="token comment">// 这个options 就包含了用户创建实例时传入的所有属性 Vue.options</span>
    vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>options<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用户传入的参数</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span> <span class="token comment">// 调用生命周期函数</span>
    <span class="token comment">// vm._data = vm.$options.data; // 获取用户传入的data</span>
    <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化状态 data/methods/props/computed/watcher/provide/inject</span>

    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span> <span class="token comment">// 执行了created函数</span>
    <span class="token comment">// 需要通过模板进行渲染</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 用户传入了el属性</span>
      vm<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 可能是字符串 也可以传入一个dom对象 #app</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    el <span class="token operator">=</span> vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取el属性</span>

    <span class="token comment">// 如果同时传入 template 和render  默认会采用render 抛弃template，如果都没传就使用id=&quot;app&quot;中的模板</span>
    <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">;</span> <span class="token comment">// 获取用户传入的所有参数</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>opts<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 没有render方法</span>
      <span class="token keyword">let</span> template <span class="token operator">=</span> opts<span class="token punctuation">.</span>template<span class="token punctuation">;</span> <span class="token comment">// 获取模板</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>template <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 应该使用外部的模板</span>
        template <span class="token operator">=</span> el<span class="token punctuation">.</span>outerHTML<span class="token punctuation">;</span> <span class="token comment">// 获取外部模板</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token comment">// &lt;div id=&quot;app&quot;&gt;&lt;p&gt;hello&lt;/p&gt;&lt;/div&gt;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// div v-if v-show {{  }}</span>
      <span class="token comment">// compileToFunctions =&gt; render函数  相当于把template模板编译成了render函数，这个函数一致性就会返回当前组件的虚拟dom</span>
      opts<span class="token punctuation">.</span>render <span class="token operator">=</span> render<span class="token punctuation">;</span> <span class="token comment">// render函数执行返回一个当前组件的虚拟dom结构</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 走到这里说明不需要编译了 ，因为用户传入的就是 一个render函数</span>
    <span class="token function">mountComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 组件的挂载流程</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>5，initMixin方法内部会把_init挂载到Vue原型上</p> <p>6，_init方法内部在执行数据挂载之前，先通过callHook函数调用beforeCreate函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>    <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化状态 data/methods/props/computed/watcher/provide/inject</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>7，内部会判断是否有data选项，如果有，通过initData执行数据的响应式处理initData（vm）</p> <p>8，处理data数据：判断data是不是一个函数，如果是函数通过call方法，this执行vm之后再带哦用【使用的时候data函数内部的this指向的是vue实例】，如果不是一个函数，直接赋值</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 数据响应式原理 data中的数据需要做一个数据劫持，当我改变数据时，应该更新视图</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data<span class="token punctuation">;</span> <span class="token comment">// 用户传入的数据挂载到了vm.$options上</span>
  <span class="token comment">// this.data = vm.$options.data</span>
  <span class="token comment">// vm._data 就是检测后的数据了</span>
  <span class="token comment">// vm._data是做什么的？ 为了方便后续的操作，将用户传入的data数据，放到vm._data上</span>
  <span class="token comment">// 为data做一个代理，方便用户直接通过vm.key 获取到data里面的属性，用this.key也可以获取到data里面的属性</span>
  <span class="token comment">// 为什么可以使用this进行访问到？ 因为在initState中，已经将data代理到了vm实例上了</span>
  <span class="token comment">// 修改this指向，指向vm实例</span>
  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">data</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">:</span> data<span class="token punctuation">;</span>
  <span class="token comment">// 观测数据</span>
  <span class="token comment">// 将数据全部代理到vm的实例上</span>

  <span class="token comment">// this.msg</span>
  <span class="token comment">// this.data.msg</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 将data上的所有属性都代理到vm上</span>
    <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'_data'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 效果：已经可以使用this.key 获取到data里面的属性了，也可以设置属性了，经过了数据的代理</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 观测这个数据</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>9，【数据的代理】遍历data数据：initDdata中的observe（data）观测这个数据</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 对象就是使用defineProperty 来实现响应式原理</span>
  <span class="token comment">// 如果这个数据不是对象 或者是null 那就不用监控了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 对象或者数组</span>
  <span class="token comment">// 当前数据是否已经被响应式劫持过</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>__ob__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// if (data.__ob__ instanceof Observer) { // 防止对象被重复观测</span>
  <span class="token comment">//   return;</span>
  <span class="token comment">// }</span>

  <span class="token comment">// 对数据进行defineProperty</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可以看到当前数据是否被观测过</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>使用Object.defineProperty进行数据劫持</p> <p>【获取属性】组件内部通过this.【data里面的键】获取值的时候，会返回vm上的_data里面的数据</p> <p>【设置属性】通过this.【data里面的键】设置键的时候，属性设置给数据，而不是直接添加到vm实例上</p> <p>10，【数据劫持】调用observe（data），开始执行真正的响应式操作</p> <p>11，第一步：coustructor会先给当前的数据打一个标记，__ob__添加了这个属性就不需要二次处理，添加一个，不可枚举，不可以遍历。添加了一个，不可删除，不能修改，不可以重新定义，不可配置。</p> <p>12，先判断是不是一个数组，因为数组和对象的处理方法不一样，如果是一个数组的话：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 先判断是不是一个数组，因为数组的索引是可以被改变的，所以需要对数组的索引进行拦截</span>
    <span class="token comment">// 为什么这里的data会有数组类型？ 因为vue是可以监控数组的变化的,所以这里的data可能是数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果是数组的话，就要重写数组的方法</span>
      <span class="token comment">// vue如何对数组进行处理呢？ 数组用的是重写数组的方法  函数劫持</span>
      <span class="token comment">// 改变数组本身的方法我就可以监控到了</span>
      data<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> arrayMethods<span class="token punctuation">;</span> <span class="token comment">// 重写当前数组的原型方法</span>
      <span class="token comment">// 每一级的数组和对象都要进行劫持,如果是数组的话，就要重写数组的方法，如果是对象的话，就要重写对象的方法</span>
      <span class="token comment">// 劫持之后，做成响应式数据</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//   1、重写数组的原型方法(push,....7个)</span>
      <span class="token comment">//   2、遍历数组，判断每一项是不是对象或者数组，如果是继续处理，上一个数组的内部</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// data是一个对象</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可以对数据一步一步的处理</span>
    <span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>这里数组的响应式和对象的响应式是不一样的，但是我们先判断是不是一个数组，再判断是不是一个对象。因为：数组也是一个对象，如果先判断对象，没有办法分辨出是一个数组还是一个对象了。</p> <p>13，数组劫持了数组的七个方法，vue重写可以改变数组的七种方法；如果是对象的话：劫持Object.defineProperty；</p> <p>处理数组的方法，进行递归遍历，一直遍历到普通数据类型</p> <p>创建一个新的原型对象，传入了原生数组的原型对象，作为空对象的原型对象，这样就可以找到数组原型上的方法，而且修改对象的时候，不会影响到原数组的原型方法</p> <p>把数组的原型指向这个新的对象，当调用数组的方法的时候，先从这个新对象上去找，如果找不到的话，去数组的原型上找</p> <p>重新编写数组使用了AOP的切片编程</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> oldArrayMethods <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span> <span class="token comment">// 获取数组原型上的方法</span>

<span class="token comment">// 创建一个全新的对象，传入了原生数组的原型对象，作为空对象的原型对象，可以找到数组原型上的方法，而且修改对象时不会影响原数组的原型方法</span>
<span class="token comment">// 把数组的原型指向这个新的对象，当调用数组的方法时，先从这个新的对象上找，如果找不到再去数组原型上找</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> arrayMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>oldArrayMethods<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {}.__proto__</span>

<span class="token keyword">let</span> methods <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token comment">// 这七个方法都可以改变原数组</span>
  <span class="token string">'push'</span><span class="token punctuation">,</span>
  <span class="token string">'pop'</span><span class="token punctuation">,</span>
  <span class="token string">'shift'</span><span class="token punctuation">,</span>
  <span class="token string">'unshift'</span><span class="token punctuation">,</span>
  <span class="token string">'sort'</span><span class="token punctuation">,</span>
  <span class="token string">'reverse'</span><span class="token punctuation">,</span>
  <span class="token string">'splice'</span>
<span class="token punctuation">]</span>

<span class="token comment">// arr.filter()</span>

<span class="token comment">// arrayMethods = {</span>
<span class="token comment">//   push () {},</span>
<span class="token comment">//   pop() {},</span>
<span class="token comment">//   // ...</span>
<span class="token comment">// }</span>

<span class="token comment">// vue劫持数组方法的目的是什么？</span>
<span class="token comment">// object.defineProerty</span>
methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">method</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  arrayMethods<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 函数劫持 AOP</span>
    <span class="token comment">// 当用户调用数组方法时 会先执行我自己改造的逻辑 在执行数组默认的逻辑</span>
    <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>
    <span class="token comment">// oldArrayMethods原生数组的方法</span>
    <span class="token comment">// this指向数组，args是用户传递的参数，apply可以改变this指向，让this指向数组</span>
    <span class="token comment">// 为什么要用apply？因为apply可以传递多个参数</span>
    <span class="token comment">// AOP 面向切片编程,在不改变原有逻辑的基础上,对原有逻辑进行扩展,比如在原有逻辑之前或之后执行一些逻辑,这就是AOP</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> oldArrayMethods<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用数组原生的方法,指向数组</span>
    <span class="token comment">// this.arr.push('23')</span>
    <span class="token keyword">let</span> inserted<span class="token punctuation">;</span>
    <span class="token comment">// push unshift splice 都可以新增属性  （新增的属性可能是一个对象类型）</span>
    <span class="token comment">// 内部还对数组中引用类型也做了一次劫持  [].push({name:'hm'})</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'push'</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token string">'unshift'</span><span class="token operator">:</span>
        inserted <span class="token operator">=</span> args
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'splice'</span><span class="token operator">:</span> <span class="token comment">// 也是新增属性  可以修改 可以删除  [].splice(arr,1,'div')</span>
        inserted <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    inserted <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// render() // 重新渲染界面</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>如果是对象的话，进行递归，判断里面的每一项，直至递归到都是普通数据类型，给每一项添加一个get和set方法，进行数据的渲染和数据的更新，添加一个dep进行watcher的收集</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// vue2响应式有什么缺点</span>
<span class="token comment">// 1，如果数据层次过多，递归会很消耗性能【如果是一次性使用的数据，使用Object.freeze进行冻结】</span>
<span class="token comment">// 2，初次渲染的时候，性能不好，因为需要递归的去遍历对象，把属性都进行defineProperty</span>
<span class="token comment">// 3，无法检测到对象属性的新增和删除，因为vue2是在初始化的时候，对属性进行defineProperty，所以无法检测到对象属性的新增和删除，需要使用$set方法进行变化，或者使用数组的索引进行变化</span>
<span class="token comment">// 4，数组的变化无法检测到，因为数组的变化方法没有被重写，所以无法检测到数组的变化，需要使用$set方法进行变化，或者使用数组的索引进行变化</span>
<span class="token comment">// 5，如果数据对象中嵌套了太多层次的对象，那么递归的去遍历对象，会造成性能的浪费</span>
<span class="token comment">// 数据劫持的是数组的方法</span>
<span class="token comment">// 为什么数组不适用Object.defineProperty</span>
<span class="token comment">// 初始化的时候只劫持data已经存在的属性</span>
<span class="token comment">// 检测不到数据key的删除</span>
<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// data对象  key msg  value 23·</span>
    <span class="token comment">// 如果值是一个对象的话，就继续递归循环检测,如果是基本类型的话，就不用递归了</span>
    <span class="token comment">// 如果传入的值还是一个对象的话 就做递归循环检测</span>
    <span class="token comment">// 数据对象，每个人都会获取到一个dep，相当于收集依赖的容器</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 给数据的每一个属性都增加一个get和set方法</span>
  <span class="token keyword">let</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// msg.dep =[watcher]  age.dep = [watcher]  // 渲染watcher中.deps [msg.dep,age.dep]</span>
  <span class="token comment">// 观察者，get收集依赖，set触发依赖。收集watcher，触发watcher</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取数据的时候会触发，初始化数据的时候，不会触发get</span>
      <span class="token comment">// 编译模板的时候会获取数据，获取数据会触发当前数据的get方法</span>
      <span class="token comment">// get触发的时候，会把当前的组件更新方法，添加到dep中</span>
      <span class="token comment">// vue的更新操作是组件级别的</span>
      <span class="token comment">// 这里会有取值的操作，给这个属性增加一个dep，这个dep 要和刚才我放到全局变量的上的watcher 做一个对应关系</span>
      <span class="token comment">// 添加观察者</span>
      <span class="token comment">// 当前数据被哪个组件使用到了，当前组件的更新方法添加到观察者</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让这个dep 去收集watcher</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 修改数据的时候会触发，初始化数据的时候，不会触发set</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">==</span> value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 如果新值和老值一样，就不用更新了</span>
      <span class="token function">observe</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 监控当前设置的值，有可能用户给了一个新值，用户设置的最新的值</span>
      value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
      <span class="token comment">// 当我们更新数据后 要把当前自己对应的watcher 去重新执行以下.</span>
      <span class="token comment">// 手机进去的依赖进行更新</span>
      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 更新数据的时候，把get方法中收集的watcher全部执行一遍</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h2 id="编译模板的步骤-ast"><a href="#编译模板的步骤-ast" class="header-anchor">#</a> 编译模板的步骤 AST</h2> <p>initMixin给给构造函数的原型上添加方法，添加_init和this指向initMixin赋值给vm</p> <p>vm获取用户传入的参数</p> <p>使用Vue.prototypr.$mount函数，获取到vm的实例化对象，然后获取到el的属性</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 可能是字符串 也可以传入一个dom对象 #app</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    el <span class="token operator">=</span> vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取el属性</span>
<span class="token comment">// 如果同时传入 template 和render  默认会采用render 抛弃template，如果都没传就使用id=&quot;app&quot;中的模板</span>
<span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">;</span> <span class="token comment">// 获取用户传入的所有参数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>获取到用户传入的参数，进行判断有没有render方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>opts<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 没有render函数</span>
      <span class="token keyword">let</span> template <span class="token operator">=</span> opts<span class="token punctuation">.</span>template<span class="token punctuation">;</span> <span class="token comment">// 获取模板</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>template <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 应该使用外部的模板</span>
        template <span class="token operator">=</span> el<span class="token punctuation">.</span>outerHTML<span class="token punctuation">;</span> <span class="token comment">// 获取外部模板</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token comment">// &lt;div id=&quot;app&quot;&gt;&lt;p&gt;hello&lt;/p&gt;&lt;/div&gt;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// div v-if v-show {{  }}</span>
      <span class="token comment">// compileToFunctions =&gt; render函数  相当于把template模板编译成了render函数，这个函数一致性就会返回当前组件的虚拟dom</span>
      opts<span class="token punctuation">.</span>render <span class="token operator">=</span> render<span class="token punctuation">;</span> <span class="token comment">// render函数执行返回一个当前组件的虚拟dom结构</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如果调用的时候没有render函数，就会去获取模板，首先获取外部模板，编译程div的格式，这个时候的div格式是字符串类型</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>      <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// div v-if v-show {{  }}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果调用的时候有render函数，直接走编译</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 可能是字符串 也可以传入一个dom对象 #app</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    el <span class="token operator">=</span> vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取el属性</span>

    <span class="token comment">// 如果同时传入 template 和render  默认会采用render 抛弃template，如果都没传就使用id=&quot;app&quot;中的模板</span>
    <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">;</span> <span class="token comment">// 获取用户传入的所有参数</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>opts<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 没有render方法</span>
      <span class="token keyword">let</span> template <span class="token operator">=</span> opts<span class="token punctuation">.</span>template<span class="token punctuation">;</span> <span class="token comment">// 获取模板</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>template <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 应该使用外部的模板</span>
        template <span class="token operator">=</span> el<span class="token punctuation">.</span>outerHTML<span class="token punctuation">;</span> <span class="token comment">// 获取外部模板</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token comment">// &lt;div id=&quot;app&quot;&gt;&lt;p&gt;hello&lt;/p&gt;&lt;/div&gt;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// div v-if v-show {{  }}</span>
      <span class="token comment">// compileToFunctions =&gt; render函数  相当于把template模板编译成了render函数，这个函数一致性就会返回当前组件的虚拟dom</span>
      opts<span class="token punctuation">.</span>render <span class="token operator">=</span> render<span class="token punctuation">;</span> <span class="token comment">// render函数执行返回一个当前组件的虚拟dom结构</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 走到这里说明不需要编译了 ，因为用户传入的就是 一个render函数</span>
    <span class="token function">mountComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 组件的挂载流程</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>1，parseHTML编译出来ast语法树（静态节点编译优化）【进行正则匹配】</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">let</span> ast <span class="token operator">=</span> <span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '&lt;div&gt;&lt;/div&gt;'进行页面编译，把字符串编译成ast语法树</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>创建AST树，进行正则的匹配</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//              字母a-zA-Z_ - . 数组小写字母 大写字母</span>
<span class="token keyword">const</span> ncname <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[a-zA-Z_][\\-\\.0-9_a-zA-Z]*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// 标签名</span>
<span class="token comment">// ?:匹配不捕获   &lt;aaa:aaa&gt;</span>
<span class="token keyword">const</span> qnameCapture <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">((?:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\:)?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token comment">// startTagOpen 可以匹配到开始标签 正则捕获到的内容是 (标签名)</span>
<span class="token keyword">const</span> startTagOpen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 标签开头的正则 捕获的内容是标签名</span>
<span class="token comment">// 闭合标签 &lt;/xxxxxxx&gt;</span>
<span class="token keyword">const</span> endTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;\\/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[^&gt;]*&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 匹配标签结尾的 &lt;/div&gt;</span>
<span class="token comment">// &lt;div aa   =   &quot;123&quot;  bb=123  cc='123'</span>
<span class="token comment">// 捕获到的是 属性名 和 属性值 arguments[1] || arguments[2] || arguments[2]</span>
<span class="token keyword">const</span> attribute <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*([^\s&quot;'&lt;&gt;\/=]+)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|'([^']*)'+|([^\s&quot;'=&lt;&gt;`]+)))?</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span> <span class="token comment">// 匹配属性的</span>
<span class="token comment">// &lt;div &gt;   &lt;br/&gt;</span>
<span class="token keyword">const</span> startTagClose <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*(\/?)&gt;</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span> <span class="token comment">// 匹配标签结束的 &gt;</span>
<span class="token comment">// 匹配动态变量的  +? 尽可能少匹配</span>
<span class="token keyword">const</span> defaultTagRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\{\{((?:.|\r?\n)+?)\}\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parseHTML</span><span class="token punctuation">(</span><span class="token parameter">html</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ast 树 表示html的语法</span>
  <span class="token keyword">let</span> root<span class="token punctuation">;</span> <span class="token comment">// 树根</span>
  <span class="token keyword">let</span> currentParent<span class="token punctuation">;</span> <span class="token comment">// 标识当前父亲是谁</span>
  <span class="token keyword">let</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 用来判断标签是否正常闭合  [div]  解析器可以借助栈型结构</span>
  <span class="token comment">// &lt;div id=&quot;app&quot; style=&quot;color:red&quot;&gt;&lt;span&gt;    helloworld {{msg}}   &lt;/span&gt;&lt;/div&gt;</span>

  <span class="token comment">// vue2.0 只能有一个根节点 必须是html 元素</span>

  <span class="token comment">// 常见数据结构 栈 队列 数组 链表 集合 hash表 树</span>
  <span class="token keyword">function</span> <span class="token function">createASTElement</span><span class="token punctuation">(</span><span class="token parameter">tagName<span class="token punctuation">,</span> attrs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 产生ast元素的</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token comment">// ast语法树 用对象来描述原生语法</span>
      <span class="token literal-property property">tag</span><span class="token operator">:</span> tagName<span class="token punctuation">,</span> <span class="token comment">// 标签名</span>
      attrs<span class="token punctuation">,</span>  <span class="token comment">// 属性</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 子元素</span>
      <span class="token literal-property property">parent</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 父亲是谁</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token comment">// 1 普通元素  3 文本</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// console.log(html)</span>
  <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">tagName<span class="token punctuation">,</span> attrs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 开始标签 每次解析开始标签 都会执行此方法</span>
    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token function">createASTElement</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      root <span class="token operator">=</span> element<span class="token punctuation">;</span> <span class="token comment">// 只有第一次是根</span>
    <span class="token punctuation">}</span>
    currentParent <span class="token operator">=</span> element<span class="token punctuation">;</span> <span class="token comment">// 标识当前父亲是谁</span>
    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将开始标签存放到栈中</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// &lt;div&gt; &lt;span&gt;&lt;/span&gt; hello world&lt;/div&gt;   [div,span]</span>
  <span class="token keyword">function</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token parameter">tagName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 结束标签  确立父子关系</span>
    <span class="token keyword">let</span> element <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取出栈中的最后一个</span>
    currentParent <span class="token operator">=</span> stack<span class="token punctuation">[</span>stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 取出当前的父亲是谁</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentParent<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 在闭合时可以知道这个标签的父亲是谁</span>
      element<span class="token punctuation">.</span>parent <span class="token operator">=</span> currentParent<span class="token punctuation">;</span> <span class="token comment">// 在闭合时可以知道这个标签的父亲是谁</span>
      currentParent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 实现了一个树的父子关系</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">chars</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 文本</span>
    text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 去掉空格</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果是空字符串 不处理</span>
      currentParent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// 将文本放到当前父亲的children中</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// 文本类型</span>
        text <span class="token comment">// 文本内容</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 根据 html 解析成树结构  &lt;/span&gt;&lt;/div&gt;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 只要html不为空字符串 就一直解析</span>
    <span class="token keyword">let</span> textEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 查找&lt;的位置</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果当前索引为0 说明是一个标签 开始标签或者结束标签</span>
      <span class="token keyword">const</span> startTageMatch <span class="token operator">=</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过这个方法获取到匹配的结果 tagName,attrs</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>startTageMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 开始标签</span>
        <span class="token function">start</span><span class="token punctuation">(</span>startTageMatch<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span> startTageMatch<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span> <span class="token comment">// 开始标签的处理</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> endTagMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 匹配结束标签</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>endTagMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">advance</span><span class="token punctuation">(</span>endTagMatch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除结束标签</span>
        <span class="token function">end</span><span class="token punctuation">(</span>endTagMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 将结束标签传入</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 结束标签</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果不是0 说明是文本</span>
    <span class="token keyword">let</span> text<span class="token punctuation">;</span> <span class="token comment">// 文本</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      text <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> textEnd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 是文本就把文本内容进行截取</span>
      <span class="token function">chars</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将文本进行处理</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">advance</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除文本内容</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">advance</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除指定的内容</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagOpen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 匹配开始标签</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">tagName</span><span class="token operator">:</span> start<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 匹配到的标签名</span>
        <span class="token literal-property property">attrs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 匹配到的属性</span>
      <span class="token punctuation">}</span>
      <span class="token function">advance</span><span class="token punctuation">(</span>start<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> end<span class="token punctuation">,</span> attr<span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>end <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagClose<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>attr <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 只要不是结尾标签 并且能匹配到属性 就一直解析</span>
        <span class="token function">advance</span><span class="token punctuation">(</span>attr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除属性</span>
        match<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> attr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> attr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">||</span> attr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">||</span> attr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 将属性放到match的attrs中</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">advance</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除开始标签结束的 &gt;</span>
        <span class="token keyword">return</span> match<span class="token punctuation">;</span> <span class="token comment">// 返回匹配的结果</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> root<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br></div></div><p>将AST进行优化</p> <p>优化的目标：生成模板AST，检测不需要进行DOM改变的静态子树，一定那检测到这些静态树，我们就能做以下这些事情</p> <p>（1）把他们变成常熟，这样我们就再也不需要每次重新渲染时创建新的节点了</p> <p>（2）在patch的过程中直接进行跳过</p> <p>2，generate编译出可执行的函数字符串【遍历语法树，进行字符串的拼接】</p> <p>3，使用with包裹【拼接字符串】，拼接字符串的时候会为变量添加this指向，这样模板使用data中的数据的时候，就不用写this了</p> <p>4，new Function把字符串变成可执行函数</p> <p>如果走到最后，说不需要进行编译了，用户传入的就是一个render函数，直接给函数vm实例和el进行挂载</p> <p>使用mountComponent，进行callHook函数调用</p> <p>调用mountComponent函数进行新旧dom的对比，使用Watcher进行页面的更新</p> <h2 id="虚拟dom进行对比"><a href="#虚拟dom进行对比" class="header-anchor">#</a> 虚拟dom进行对比</h2> <p>callHook挂载前获取vm实例和beforeMount钩子，然后开始编译</p> <p>在updataComponent函数中进行新旧dom的对比，调用render方法后返回的时虚拟dom</p> <p>每次数据发生变化，旧执行update方法 new Watcher进行页面的更新</p> <p>创建Watcher的实例化对象，所以Watcher时更新数据的方法</p> <h2 id="观察者模式"><a href="#观察者模式" class="header-anchor">#</a> 观察者模式</h2> <p>使用Object.defineProperty对对象数据进行拦截，判断是否有__ob__的属性，如果没有__ob__的情况下，会添加一个__ob__，然后添加不可枚举和不可修改的属性。</p> <p>进行判断data是不是数组类型，如果是数组类型的情况下，vue进行函数劫持，然后重写数组的原型方法，如果说劫持的是数组就改变数组的七种方法，如果说劫持的是对象就改变对象的方法。</p> <p>如果值是一个对象的话defineReactive，就继续递归循环检测，如果说是基本类型的话，就不用进行递归。传入对象就进行递归的循环检测，给每一个数据添加一个dep，收集依赖的容器，用来收集watcher。声明一个new Dep，进行赋值。【开启观察者模式】get进行依赖的watcher的收集，set触发依赖，触发watcher中的run方法以及进行数据的更新。</p> <p>get获取数据的时候会触发，初始化数据的时候，不会触发get。编译模板的时候会获取数据，获取数据会触发当前的数据的get方法，get触发的时候会把当前组件进行更新，添加到dep中，vue的更新操作是组件级别的，这个会有一个取值的操作，给这个属性添加一个dep要和全局变量的watcher做出一个对应关系。</p> <p>下一步，把watcher储存到deo中</p> <p>dep和watcher是典型的观察者模式，dep是目标（有一个subs），watcher是观察者，把watcehr储存到sunes里面，对数据进行观测，当目标数据方法变化的时候，通知所有的观察者，观察者执行对应的方法，更新视图。更新视图的方法是调用notify，进行修改，触发set方法。</p> <p>为什么让watcher储存到dep中？因为watcher是组件级别的，dep是全局唯一的，所以让watcher进行dep储存，储存之后进行模板编译</p> <h2 id="观察者模式进行数据更新"><a href="#观察者模式进行数据更新" class="header-anchor">#</a> 观察者模式进行数据更新</h2> <p>触发set方法，然后触发dep.notify()方法，notify中有一个subs数组，存的是需要更新的watcher，然后watcher中调用updata函数触发然后queueWatcher函数，将watcher进行修改，进行页面视图的更新处理</p> <p>首先要知道一个概念，Vue是组件化更新页面的，Vue一个组件中有多个属性，会产生多个watcher，但是这些watcher的id是相同的。【Vue中不同的组件的watcher id是不相同的，但是同一个组件的watcher id是相同的】</p> <p>数据更新步骤</p> <p>第一步：首先给watcher储存到一个队列当中【等待多个组件一起储存，一起更新】</p> <p>第二步：页面同步更新的时候，当前watcher.id已经存在了，不需要再次进行储存，这样，页面的同步更新和异步更新都会进行更新操作</p> <p>第二部：等待更新，清空队列，一直执行watcher的set方法，set方法会触发dep.notify（），dep.notify（）会触发watcher的updata方法</p> <p>第四步：执行watcher的run方法，调用get方法，重新进行页面的渲染</p> <h2 id="nexttick页面的异步的更新"><a href="#nexttick页面的异步的更新" class="header-anchor">#</a> nextTick页面的异步的更新</h2> <p>nextTick，想要获取最新的页面dom结构的时候需要使用到nextTick</p> <p>当修改完数据以后，会触发当前数据的set方法，通知当前数据在get阶段收集到的所有依赖【watcher】进行更新，更新不是同步更新的，而是通过nextTick注册异步任务进行更新，所以修改完数据以后想要立即获取最新的页面结构是获取不到的。</p> <p>这个时候我们可以使用nextTick继续注册一个异步任务</p> <p>同步代码走完，开始清空异步任务</p> <p>nextTick的异步任务类型是根据宿主环境进行判断promise,mutationObserver,setImmediate,setTimeout。</p> <p>场景：行内编辑的时候，自动获取焦点</p> <p>修改完数据之后，会触发set方法，通知set阶段收集watcher触发updata方法，将watcher储存到更新队列中，使用nextTick中的定时器进行异步更新，进行队列的清空，一次执行watcher的run方法，调用get方法，重新进行渲染。也就是当数据进行修改的时候，为什么需要nextTick进行异步操作才能拿到数据？当data中的数据初始化的时候，劫持这个数据，使用get和set方法，触发数据的get方法，页面进行渲染，数据初始化完成之后，编译模板，将模板中的数据和页面进行绑定。get只要触发了，当前组件更新watcher就会被收集到Dep里面【观察者模式】</p> <p>如果我们修改了data里面的数据，会触发set方法，set方法触发dep.notify()，depnotify()会触发watcher的updata方法。就把收集到所有的依赖【更新watcher】，通过nextTick进行异步更新，清空队列，一次执行watcher的run方法，调用get方法，重新进行页面的渲染。</p> <p>nextTick的异步根据宿主环境进行何种异步的更新判断。promise，mutationObserver,setImmediate,setTimeout.</p> <h2 id="步骤详解"><a href="#步骤详解" class="header-anchor">#</a> 步骤详解</h2> <p>new vue之后传入一个_init方法，使用initMixin（vue），把_init方法挂载到vue的原型上</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加原型的方法</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=Vue" title="标签">#Vue</a><a href="/tags/?tag=%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93" title="标签">#面试总结</a></div> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2023/04/25, 01:33:08</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/3d4029/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">new Vue的流程</div></a> <a href="/pages/e1d719/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Vue2 Diff 算法</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/3d4029/" class="prev">new Vue的流程</a></span> <span class="next"><a href="/pages/e1d719/">Vue2 Diff 算法</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/c87550/"><div>
            变更Git作者邮箱信息
            <!----></div></a> <span class="date">02-11</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/08929e/"><div>
            大文件上传技术实现
            <!----></div></a> <span class="date">05-17</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/77f5b4/"><div>
            什么？后端要一次性返回我10万条数据！且看我这8种方案机智应对！
            <!----></div></a> <span class="date">11-01</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:wuwanming0405@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/Ming-D-W" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/user/home?id=515874856" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2025
    <span>Ming | blog<br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33019202000592" target="_blank" style="margin-right: 20px; height:20px;line-height:20px;"><img src="https://photo-album-1314189846.cos.ap-shanghai.myqcloud.com/202304131844613.png" style="height:18px; margin: 0px 5px 0px 0px;"/>浙公网安备 33019202000592号</a> <a href="http://beian.miit.gov.cn/" target="_blank">陇ICP备2023000815号-1</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div><div></div><div></div><div class="fantasy"><canvas id="cvs" width="1980" height="1080" class="hidden"></canvas> <canvas id="screenImage" width="234" height="357" class="hidden"></canvas> <canvas id="rili" width="600" height="600" class="hidden"></canvas> <canvas id="display"></canvas></div><div></div><!----><div></div></div></div>
    <script src="/assets/js/app.9ce89328.js" defer></script><script src="/assets/js/2.f5951ee7.js" defer></script><script src="/assets/js/82.d8694b66.js" defer></script><script src="/assets/js/15.8f34ae65.js" defer></script><script src="/assets/js/5.80fa8520.js" defer></script><script src="/assets/js/9.a3a07a71.js" defer></script><script src="/assets/js/8.00efa629.js" defer></script>
  </body>
</html>
